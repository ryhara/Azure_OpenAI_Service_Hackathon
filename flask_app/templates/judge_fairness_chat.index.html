{% extends "layout.html" %}

{% block body %}

<div class="container d-flex flex-column justify-content-center align-items-center">
	<div id="chat-box" class="mt-3 w-75">
			<!-- chat will be displayed here -->
	</div>
	<div class="chat-form-container fixed-bottom text-center">
		<form id="chat-form" class="input-group w-50 mx-auto mb-4">
			<div class="input-group-append">
				<label class="input-group-text" for="pdf-input">
					<i class="bi bi-filetype-pdf"></i>
				</label>
				<input type="file" id="pdf-input" accept="application/pdf" class="form-control" style="display: none;">
			</div>
			<textarea id="chat-input" class="form-control" placeholder="Type a message..." rows="1"></textarea>
			<div class="input-group-append">
					<button type="submit" class="btn btn-dark">
							<i class="bi bi-send-fill"></i>
					</button>
			</div>
		</form>
		<div class="chat-instructions text-center w-50 mx-auto mb-1">
				Shift + Enter or Click button to send a message
		</div>
	</div>
</div>


<style>
	#chat-box {
    max-height: 700px;
    overflow-y: auto;
}
	#chat-form {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
	}
	#chat-form .btn {
			border-top-left-radius: 0;
			border-bottom-left-radius: 0;
	}
	#chat-input {
		max-height: 100px;
		overflow-y: auto;
	}
	.chat-instructions {
			color: #999;
			font-size: 12px;
	}
	pre {
			white-space: pre-wrap;
			word-wrap: break-word;
	}
</style>

<script>
	document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('chat-form').querySelector('button[type="submit"]').click();
    }
});
</script>

<script>
	const textarea = document.getElementById('chat-input');

	textarea.addEventListener('input', function() {
			// スクロール高さに基づいて高さを設定
			this.style.height = 'auto';
			const maxHeight = 100;
			this.style.height = Math.min(this.scrollHeight, maxHeight) + 'px';
	});
</script>

<script>
	function escapeHtml(text) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}
	document.getElementById('chat-form').addEventListener('submit', function(e) {
		e.preventDefault();
		const inputElement = document.getElementById('chat-input');
    const message = inputElement.value.trim();
    const pdfInput = document.getElementById('pdf-input');
    const pdfFile = pdfInput ? pdfInput.files[0] : null;
		inputElement.value = '';
		pdfInput.value = '';
    if (message === '' && !pdfFile) {
        alert('Please enter a message or select a PDF file.');
        return;
    }

    const formData = new FormData();
    if (message !== '')
				formData.append('message', message);
    if (pdfFile)
        formData.append('pdf', pdfFile);

		inputElement.style.height = 'auto';
		const chatBox = document.getElementById('chat-box');
		const userMessage = document.createElement('div');
		userMessage.classList.add('mb-1', 'user-message');
		userMessage.innerHTML = `<p class="text-primary-emphasis"><i class="bi bi-person-fill"></i> <strong>User</strong></p><pre>${escapeHtml(message)}</pre>`;
		chatBox.appendChild(userMessage);
    fetch('/judge_fairness_chat/send_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
		.then(data => {
			const botMessage = document.createElement('div');
			botMessage.classList.add('mb-1', 'bot-message');
			botMessage.innerHTML = `<p><i class="bi bi-robot"></i> <strong>Bot</strong></p><pre>${escapeHtml(data)}</pre>`;
			chatBox.appendChild(botMessage);

			chatBox.appendChild(document.createElement('hr'));
			chatBox.scrollTop = chatBox.scrollHeight;

		}, (error) => {
			console.log(error);
		});
	});
</script>


{% endblock %}