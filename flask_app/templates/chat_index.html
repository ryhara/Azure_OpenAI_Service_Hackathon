{% extends "layout.html" %}

{% block body %}

<div class="container d-flex flex-column justify-content-center align-items-center">
	<div id="chat-box" class="mt-3 w-75">
			<!-- chat will be displayed here -->
	</div>
	<div class="chat-form-container fixed-bottom text-center">
		<form id="chat-form" class="input-group w-50 mx-auto mb-4">
				<textarea id="chat-input" class="form-control" placeholder="Type a message..." rows="1"></textarea>
				<button type="submit" class="btn btn-dark"><i class="bi bi-send-fill"></i></button>
		</form>
		<div class="chat-instructions text-center w-50 mx-auto mb-1">
				Shift + Enter or Click button to send a message
		</div>
	</div>
</div>


<style>
	#chat-box {
    max-height: 700px;
    overflow-y: auto;
}
	#chat-form {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
	}
	#chat-form .btn {
			border-top-left-radius: 0;
			border-bottom-left-radius: 0;
	}
	#chat-input {
		max-height: 100px;
		overflow-y: auto;
	}
	.chat-instructions {
			color: #999;
			font-size: 12px;
	}
</style>

<script>
	document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('chat-form').querySelector('button[type="submit"]').click();
    }
});
</script>

<script>
	const textarea = document.getElementById('chat-input');

	textarea.addEventListener('input', function() {
			// スクロール高さに基づいて高さを設定
			this.style.height = 'auto';
			const maxHeight = 100;
			this.style.height = Math.min(this.scrollHeight, maxHeight) + 'px';
	});
</script>

<script>
	function escapeHtml(text) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}
	document.getElementById('chat-form').addEventListener('submit', function(e) {
			e.preventDefault();
			const inputElement = document.getElementById('chat-input');
			const message = inputElement.value.trim();
			inputElement.value = '';
			if (message === '') {
				inputElement.style.height = 'auto';
				return;
			}

			inputElement.style.height = 'auto';
			fetch('/send_message', {
					method: 'POST',
					body: new URLSearchParams('message=' + message),
					headers: {
							'Content-Type': 'application/x-www-form-urlencoded',
					},
			})
			.then(response => response.text())
			.then(data => {
				const chatBox = document.getElementById('chat-box');
				const userMessage = document.createElement('div');
				userMessage.classList.add('mb-1', 'user-message');
				userMessage.innerHTML = `<p class="text-primary-emphasis"><i class="bi bi-person-fill"></i> <strong>User</strong></p><pre>${escapeHtml(message)}</pre>`;
				chatBox.appendChild(userMessage);

				const botMessage = document.createElement('div');
				botMessage.classList.add('mb-1', 'bot-message');
				botMessage.innerHTML = `<p><i class="bi bi-robot"></i> <strong>Bot</strong></p><pre>${escapeHtml(data)}</pre>`;
				chatBox.appendChild(botMessage);

				chatBox.appendChild(document.createElement('hr'));
				chatBox.scrollTop = chatBox.scrollHeight;

			}, (error) => {
				console.log(error);
			});
	});
</script>


{% endblock %}